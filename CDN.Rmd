---
title: "Social segregation in Core Discussion Networks"
author: '[Jochem Tolsma](https://www.jochemtolsma.nl) - Radboud University / University of Groningen, the Netherlands'
bibliography: references.bib
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
output: 
  html_document:
    css: tweaks.css
    toc:  true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: yes
---

```{r globalsettings, echo=FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, echo=FALSE, class.source=c("test"), class.output=c("test2"))
options(width = 100)
rgl::setupKnitr()
```

```{r colorize, echo=FALSE}
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_html_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
            x)
  } else x
}

```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```


---


#  Intro


This [website](https://jochemtolsma.github.io/JCA/) is a replication package for presentation at JCA by @Tolsma2021.

It contains R code to replicate all the Tables and Figures.

To copy the code click the button in the upper right corner of the code-chunks.

Use the top menu to navigate to the section of interest. 

The source code of this website can be found on [Github](https://github.com/JochemTolsma/JCA)

Questions can be addressed to [Jochem Tolsma](mailto:jochem.tolsma@ru.nl).

---  



# Custom functions

- `pacage.check`: Check if packages are installed (and install if not) in R ([source](https://vbaliga.github.io/verify-that-r-packages-are-installed-and-loaded/)). 



```{r, results='hide'}
fpackage.check <- function(packages) {
  lapply(packages, FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  })
}


```

---  

# Packages


- `tidyverse`: if you can't base them, join them  
- `haven`: because we have haven labelled vars in the dataset.  
- `Hmisc`: for weighted mean/sd  



```{r, results='hide'}
packages = c("tidyverse", "haven", "Hmisc")

fpackage.check(packages)

```

--- 

# Dataset

```{r}
load(file="./data/liss_merged_core_file_v3_0921.Rdata")
```

## some prep

Thijmen, how do I know ego participated?: just select on missings
how do I know that an alter is mentioned?: check alter_id NA

Liss representative with respect to educ measured in four cats? 

```{r}

#attributes(liss_wide$oplcat.10)
#prop.table(table(liss_wide$oplcat.11, useNA = "always"))
#round(prop.table(table(liss_wide$oplcat.11)),2)

sample_val <- NA
sample_val[1] <- (table(liss_wide$oplcat.11))[1]
sample_val[2] <- (table(liss_wide$oplcat.11))[2]
sample_val[3] <- (table(liss_wide$oplcat.11))[3] + (table(liss_wide$oplcat.11))[4]
sample_val[4] <- (table(liss_wide$oplcat.11))[5]
sample_val[5] <- (table(liss_wide$oplcat.11))[6]


#cbs https://opendata.cbs.nl/#/CBS/nl/dataset/82816NED/table?ts=1646133108517
datacbs <- c(1265,	2847,	5211,	3122,	1850)
levels(datacbs) <- c("primair", "vmbo", "havo/vwo/mbo", "hbo", "wo")
#round(datacbs / sum(datacbs),2)
pop_val <- datacbs / sum(datacbs)

test <- chisq.test(x=sample_val, p=pop_val, rescale.p = TRUE)
test_data <- data.frame(round(test$observed),round(test$expected), c("primair", "vmbo", "havo/vwo/mbo", "hbo", "wo"))
names(test_data) <- c("observed (LISS)", "expected (CBS)", "levels")
test_data
test


```

Nope, but nothing really problematic. 

Okay, lets get cracking and prepare the dataset. Once with kin-alters included and once excluded. 

kin:
```{r}
attributes(liss_wide$rel_alter1.1)
```



```{r}

liss_long %>%
  mutate(#size
        cdn_size = 5 - rowSums(is.na(cbind(alter_id_1, alter_id_2, alter_id_3, alter_id_4, alter_id_5))),
    
        #education
        opl4 = recode(as.numeric(oplmet), '1' = 1, '2'=1, '3'= 2, '4' = 2, '5' = 3, '6'=4, .default=-1 ),
        opl4 = na_if(opl4, -1), 
        opl4 = structure(opl4, labels=c("low", "medium", "high1", "high2")),
         across(c(educ_alter1,educ_alter2,educ_alter3,educ_alter4,educ_alter5), ~as.numeric(.x), .names = "{.col}_opl4"),
         across(c(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4), ~recode(.x, '4'=1, '6'=1, '10'=2, '10.5'=2, '11.5'=2 , '15'=3, '16' = 4, .default=-1)),
         across(c(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4), ~na_if(.x, -1)),
         educ_I = rowSums(cbind(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4)==opl4,na.rm=T),
         educ_E = rowSums(cbind(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4)!=opl4,na.rm=T),
         educ_EI =  - ((educ_E - educ_I) / (educ_E + educ_I)),
         cdn_neduc_h = rowSums(cbind(educ_alter1, educ_alter2, educ_alter3, educ_alter4, educ_alter5)==16, na.rm=T),
        
        #gender   
         gender_alter1 = replace_na(gender_alter1, -1),
         gender_alter2 = replace_na(gender_alter2, -1),
         gender_alter3 = replace_na(gender_alter3, -1),
         gender_alter4 = replace_na(gender_alter4, -1),
         gender_alter5 = replace_na(gender_alter5, -1),
         cdn_ngender_2 = rowSums(cbind(gender_alter1, gender_alter2, gender_alter3, gender_alter4, gender_alter5)==2, na.rm=T),
         cdn_ngender_1 = rowSums(cbind(gender_alter1, gender_alter2, gender_alter3, gender_alter4, gender_alter5)==1, na.rm=T),
         gender_I = ifelse(geslacht==2, cdn_ngender_2, cdn_ngender_1),
         gender_E = ifelse(geslacht==1, cdn_ngender_2, cdn_ngender_1),
         gender_EI =  - ((gender_E - gender_I) / (gender_E + gender_I)),
        
        #age
        across(c(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5), ~na_if(.x, 14)),
        across(c(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5), ~as.integer(.x)),
        leeftijd_cat13 = as.integer(cut(as.numeric(liss_long$leeftijd),breaks = c(-Inf, 15, 20, 25, 30, 35, 40,45,50,55,60,65,70, Inf))),
        leeftijd_I = rowSums(cbind(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5)==leeftijd_cat13, na.rm=T),
        leeftijd_E = rowSums(cbind(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5)!=leeftijd_cat13, na.rm=T),
        leeftijd_EI =  - ((leeftijd_E - leeftijd_I) / (leeftijd_E + leeftijd_I)),
         
         ego_id = nomem_encr) %>%
  filter(!is.na(pol_int))   %>%
  select(ego_id,  survey_wave, leeftijd, leeftijd_cat13,  opl4, geslacht, cdn_size, cdn_neduc_h, educ_EI, cdn_ngender_2, gender_EI, leeftijd_EI) -> datajt

#make similar dataset for non-kin. dus gooi alle alters weg met rel_alter - 1 2,3,4,5
# quickest would probably be to go from wide to long, select and go back to wide. but...


liss_long %>%
  mutate(across(c(rel_alter1,rel_alter2,rel_alter3,rel_alter4,rel_alter5), ~replace_na(.x, -1)),
         alter_id_1 = ifelse(rel_alter1>0 & rel_alter1<6, NA, alter_id_1), 
         alter_id_2 = ifelse(rel_alter2>0 & rel_alter2<6, NA, alter_id_2), 
         alter_id_3 = ifelse(rel_alter3>0 & rel_alter3<6, NA, alter_id_3), 
         alter_id_4 = ifelse(rel_alter4>0 & rel_alter4<6, NA, alter_id_4), 
         alter_id_5 = ifelse(rel_alter5>0 & rel_alter5<6, NA, alter_id_5), 
         
         educ_alter1 = ifelse(rel_alter1>0 & rel_alter1<6, NA, educ_alter1), 
         educ_alter2 = ifelse(rel_alter2>0 & rel_alter2<6, NA, educ_alter2), 
         educ_alter3 = ifelse(rel_alter3>0 & rel_alter3<6, NA, educ_alter3), 
         educ_alter4 = ifelse(rel_alter4>0 & rel_alter4<6, NA, educ_alter4), 
         educ_alter5 = ifelse(rel_alter5>0 & rel_alter5<6, NA, educ_alter5), 
         
         gender_alter1 = ifelse(rel_alter1>0 & rel_alter1<6, NA, gender_alter1), 
         gender_alter2 = ifelse(rel_alter2>0 & rel_alter2<6, NA, gender_alter2), 
         gender_alter3 = ifelse(rel_alter3>0 & rel_alter3<6, NA, gender_alter3), 
         gender_alter4 = ifelse(rel_alter4>0 & rel_alter4<6, NA, gender_alter4), 
         gender_alter5 = ifelse(rel_alter5>0 & rel_alter5<6, NA, gender_alter5)) %>%

 mutate(#size
        cdn_size = 5 - rowSums(is.na(cbind(alter_id_1, alter_id_2, alter_id_3, alter_id_4, alter_id_5))),
    
        #education
        opl4 = recode(as.numeric(oplmet), '1' = 1, '2'=1, '3'= 2, '4' = 2, '5' = 3, '6'=4, .default=-1 ),
        opl4 = na_if(opl4, -1), 
        opl4 = structure(opl4, labels=c("low", "medium", "high1", "high2")),
         across(c(educ_alter1,educ_alter2,educ_alter3,educ_alter4,educ_alter5), ~as.numeric(.x), .names = "{.col}_opl4"),
         across(c(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4), ~recode(.x, '4'=1, '6'=1, '10'=2, '10.5'=2, '11.5'=2 , '15'=3, '16' = 4, .default=-1)),
         across(c(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4), ~na_if(.x, -1)),
         educ_I = rowSums(cbind(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4)==opl4,na.rm=T),
         educ_E = rowSums(cbind(educ_alter1_opl4,educ_alter2_opl4,educ_alter3_opl4,educ_alter4_opl4,educ_alter5_opl4)!=opl4,na.rm=T),
         educ_EI =  - ((educ_E - educ_I) / (educ_E + educ_I)),
         cdn_neduc_h = rowSums(cbind(educ_alter1, educ_alter2, educ_alter3, educ_alter4, educ_alter5)==16, na.rm=T),
        
        #gender   
         gender_alter1 = replace_na(gender_alter1, -1),
         gender_alter2 = replace_na(gender_alter2, -1),
         gender_alter3 = replace_na(gender_alter3, -1),
         gender_alter4 = replace_na(gender_alter4, -1),
         gender_alter5 = replace_na(gender_alter5, -1),
         cdn_ngender_2 = rowSums(cbind(gender_alter1, gender_alter2, gender_alter3, gender_alter4, gender_alter5)==2, na.rm=T),
         cdn_ngender_1 = rowSums(cbind(gender_alter1, gender_alter2, gender_alter3, gender_alter4, gender_alter5)==1, na.rm=T),
         gender_I = ifelse(geslacht==2, cdn_ngender_2, cdn_ngender_1),
         gender_E = ifelse(geslacht==1, cdn_ngender_2, cdn_ngender_1),
         gender_EI =  - ((gender_E - gender_I) / (gender_E + gender_I)),
        
        #age
        across(c(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5), ~na_if(.x, 14)),
        across(c(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5), ~as.integer(.x)),
        leeftijd_cat13 = as.integer(cut(as.numeric(liss_long$leeftijd),breaks = c(-Inf, 15, 20, 25, 30, 35, 40,45,50,55,60,65,70, Inf))),
        leeftijd_I = rowSums(cbind(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5)==leeftijd_cat13, na.rm=T),
        leeftijd_E = rowSums(cbind(age_alter1, age_alter2, age_alter3, age_alter4, age_alter5)!=leeftijd_cat13, na.rm=T),
        leeftijd_EI =  - ((leeftijd_E - leeftijd_I) / (leeftijd_E + leeftijd_I)),
         
         ego_id = nomem_encr) %>%
  filter(!is.na(pol_int))   %>%
  select(ego_id,  survey_wave, leeftijd, leeftijd_cat13, opl4, geslacht, cdn_size, cdn_neduc_h, educ_EI, cdn_ngender_2, gender_EI, leeftijd_EI)  -> datajt_nk




  
```




--- 

# Segregation in CDN {.tabset .tabset-fade}

## Education  

```{r}

datajt %>% 
  group_by(survey_wave, opl4) %>%
  summarise(N = n(),
            cdn_sizeM = mean(cdn_size, na.rm=T),
            sd = sd(cdn_size, na.rm=T)) %>%
  mutate(
    se = sd / sqrt(N) ,
    conf.interval = .95,
    ci = se * qt(conf.interval/2 + .5, N-1)) %>% 
  na.omit() -> tgc



ggplot(tgc, aes(x=as.numeric(survey_wave), y=cdn_sizeM, colour=as.factor(opl4))) + 
    geom_errorbar(aes(ymin=cdn_sizeM-ci, ymax=cdn_sizeM+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12)) +
    scale_y_continuous(breaks = 1:5, limits = c(2,4)) + 
    labs(title = "CDN-size per education", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "CDN size", x="period") + 
    scale_colour_hue(name="education ego",    # Legend label, use darker colors
                     breaks=c("1", "2", "3", "4"),
                     labels=c("primary + vmbo", "havo/vwo/mbo", "hbo", "university"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position=c(.98,.58))  
```
Try to filter out age effect
```{r}

datajt %>% 
  filter(leeftijd>24 & leeftijd<30) %>%
  group_by(survey_wave, opl4) %>%
  summarise(N = n(),
            cdn_sizeM = mean(cdn_size, na.rm=T),
            sd = sd(cdn_size, na.rm=T)) %>%
  mutate(
    se = sd / sqrt(N) ,
    conf.interval = .95,
    ci = se * qt(conf.interval/2 + .5, N-1)) %>% 
  na.omit() -> tgc



ggplot(tgc, aes(x=as.numeric(survey_wave), y=cdn_sizeM, colour=as.factor(opl4))) + 
    geom_errorbar(aes(ymin=cdn_sizeM-ci, ymax=cdn_sizeM+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12)) +
    scale_y_continuous(breaks = 1:5, limits = c(1,4)) + 
    labs(title = "CDN-size per education", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "CDN size", x="period") + 
    scale_colour_hue(name="education ego",    # Legend label, use darker colors
                     breaks=c("1", "2", "3", "4"),
                     labels=c("primary + vmbo", "havo/vwo/mbo", "hbo", "university"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position=c(.98,.58))  
```



```{r}
datajt %>% 
  group_by(survey_wave, opl4) %>%
  summarise(N = n(),
            cdn_neduc_hM = mean(cdn_neduc_h, na.rm=T),
            sd = sd(cdn_neduc_h, na.rm=T)) %>%
  mutate(
    se = sd / sqrt(N) ,
    conf.interval = .95,
    ci = se * qt(conf.interval/2 + .5, N-1)) %>% 
  na.omit() -> tgc

ggplot(tgc, aes(x=as.numeric(survey_wave), y=cdn_neduc_hM, colour=as.factor(opl4))) + 
    geom_errorbar(aes(ymin=cdn_neduc_hM-ci, ymax=cdn_neduc_hM+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12)) +
    scale_y_continuous(breaks = 0:2, limits = c(0,2.8)) + 
    labs(title = "Number of university educated alters \n per education", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "CDN size", x="period") + 
    scale_colour_hue(name="education ego",    # Legend label, use darker colors
                     breaks=c("1", "2", "3", "4"),
                     labels=c("primary + vmbo", "havo/vwo/mbo", "hbo", "university"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position=c(.98,.54))  



```

```{r}
datajt %>% 
  filter(leeftijd>24 & !is.na(opl4)) %>%
  group_by(survey_wave, opl4) %>%
  summarise(N = n(),
            cdn_educ_EIM = mean(educ_EI, na.rm=T),
            sd = sd(educ_EI, na.rm=T),
            cdn_educ_EIM_w = wtd.mean(educ_EI, cdn_size, normwt = FALSE, na.rm = TRUE), #perhaps better to set normwt to TRUE
            sd_w = sqrt(wtd.var(educ_EI, cdn_size, normwt = FALSE, na.rm = TRUE))) %>%
  mutate(
    conf.interval = .95,
    se = sd / sqrt(N) ,
    ci = se * qt(conf.interval/2 + .5, N-1),
    se_w = sd_w / sqrt(N) , #is this correct??
    ci_w = se_w * qt(conf.interval/2 + .5, N-1)) %>%   
  na.omit() -> tgc



datajt_nk %>% 
  filter(leeftijd>24) %>%
  group_by(survey_wave, opl4) %>%
  summarise(N = n(),
            cdn_educ_EIM = mean(educ_EI, na.rm=T),
            sd = sd(educ_EI, na.rm=T)) %>%
  mutate(
    se = sd / sqrt(N) ,
    conf.interval = .95,
    ci = se * qt(conf.interval/2 + .5, N-1)) %>% 
  na.omit() -> tgc_nk

``` 
```{r}

ggplot(tgc, aes(x=as.numeric(survey_wave), y=cdn_educ_EIM, colour=as.factor(opl4))) + 
    geom_errorbar(aes(ymin=cdn_educ_EIM-ci, ymax=cdn_educ_EIM+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12), labels = as.character(c(2011:2021))) +
    scale_y_continuous(breaks = -1:1, limits = c(-1,1)) + 
    labs(title = "Educational homogeneity in CDN\n per education ", caption = "Note: 95% CI \n Source: CentERdata 2021 \n (own calculations)", 
       y = "EI-index", x="period") + 
    scale_colour_hue(name="education ego",    # Legend label, use darker colors
                     breaks=c("1", "2", "3", "4"),
                     labels=c("primary + vmbo", "havo/vwo/mbo", "hbo", "university"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position="right")  


#legend.position=c(.22,.1))


```

```{r}

ggplot(tgc, aes(x=as.numeric(survey_wave), y=cdn_educ_EIM_w, colour=as.factor(opl4))) + 
    geom_errorbar(aes(ymin=cdn_educ_EIM_w-ci_w, ymax=cdn_educ_EIM_w+ci_w), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12), labels = as.character(c(2011:2021))) +
    scale_y_continuous(breaks = -1:1, limits = c(-1,1)) + 
    labs(title = "Educational homogeneity \n per education \n weighted by CDN size ", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "EI-index", x="period") + 
    scale_colour_hue(name="education ego",    # Legend label, use darker colors
                     breaks=c("1", "2", "3", "4"),
                     labels=c("primary + vmbo", "havo/vwo/mbo", "hbo", "university"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position="right")  



```


```{r}

ggplot(tgc_nk, aes(x=as.numeric(survey_wave), y=cdn_educ_EIM, colour=as.factor(opl4))) + 
    geom_errorbar(aes(ymin=cdn_educ_EIM-ci, ymax=cdn_educ_EIM+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12)) +
    scale_y_continuous(breaks = -1:1, limits = c(-1,1)) + 
    labs(title = "Educational homogeneity \n per education \n (older than 24 & nokin)", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "CDN size", x="period") + 
    scale_colour_hue(name="education ego",    # Legend label, use darker colors
                     breaks=c("1", "2", "3", "4"),
                     labels=c("primary + vmbo", "havo/vwo/mbo", "hbo", "university"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position=c(.22,.1))  



```



## Gender  

```{r}

datajt %>% 
  filter(!is.na(geslacht)) %>%
  group_by(survey_wave, geslacht) %>%
  summarise(N = n(),
            cdn_ngender_2M = mean(cdn_ngender_2, na.rm=T),
            sd = sd(cdn_ngender_2, na.rm=T)) %>%
  mutate(
    se = sd / sqrt(N) ,
    conf.interval = .95,
    ci = se * qt(conf.interval/2 + .5, N-1)) -> datac

ggplot(datac, aes(x=as.numeric(survey_wave), y=cdn_ngender_2M, colour=as.factor(geslacht))) + 
    geom_errorbar(aes(ymin=cdn_ngender_2M-ci, ymax=cdn_ngender_2M+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12), labels = as.character(c(2011:2021))) +
    scale_y_continuous(breaks = 0:3, limits = c(0,3)) + 
    labs(title = "Female confidants \n gender", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "number of female confidants", x="period") + 
    scale_colour_hue(name="gender ego",    # Legend label, use darker colors
                     breaks=c("2", "1"),
                     labels=c("female", "male"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position=c(.98,.68))  
  
```
```{r}
datajt %>% 
  filter(cdn_size>0 & !is.na(geslacht)) %>%
  group_by(survey_wave, geslacht) %>%
  summarise(N = n(),
            gender_EI_mean = mean(gender_EI, na.rm=T),
            sd = sd(gender_EI, na.rm=T)) %>%
  mutate(
    se = sd / sqrt(N) ,
    conf.interval = .95,
    ci = se * qt(conf.interval/2 + .5, N-1)) -> datac

ggplot(datac, aes(x=as.numeric(survey_wave), y=gender_EI_mean, colour=as.factor(geslacht))) + 
    geom_errorbar(aes(ymin=gender_EI_mean-ci, ymax=gender_EI_mean+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12), labels = as.character(c(2011:2021))) +
    scale_y_continuous(breaks = c(-.5,0,.5), limits = c(-.5,.5)) + 
    labs(title = "Gender homogeneity in CDN \n (EI-index, higher scores more homogeneity)", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "EI-index", x="period") + 
    scale_colour_hue(name="gender ego",    # Legend label, use darker colors
                     breaks=c("2", "1"),
                     labels=c("female", "male"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position="right")  
  

```

```{r}



datajt_nk %>% 
  filter(cdn_size>0 & !is.na(geslacht)) %>%
  group_by(survey_wave, geslacht) %>%
  summarise(N = n(),
            gender_EI_mean = mean(gender_EI, na.rm=T),
            sd = sd(gender_EI, na.rm=T)) %>%
  mutate(
    se = sd / sqrt(N) ,
    conf.interval = .95,
    ci = se * qt(conf.interval/2 + .5, N-1)) -> datac

ggplot(datac, aes(x=as.numeric(survey_wave), y=gender_EI_mean, colour=as.factor(geslacht))) + 
    geom_errorbar(aes(ymin=gender_EI_mean-ci, ymax=gender_EI_mean+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12)) +
    scale_y_continuous(breaks = c(-.5,0,.5,1), limits = c(0,1)) + 
    labs(title = "gender homophily \n (EI-index, higher scores more homogeneity)", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "gender homophily", x="period") + 
    scale_colour_hue(name="gender ego",    # Legend label, use darker colors
                     breaks=c("1", "2"),
                     labels=c("male", "female"),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position=c(.98,.18))  
  


```




## leeftijd

```{r}
datajt %>% 
  filter(!is.na(leeftijd) & leeftijd>24) %>%
  group_by(survey_wave, leeftijd_cat13) %>%
  summarise(N = n(),
            cdn_leeftijd_EIM = mean(leeftijd_EI, na.rm=T),
            sd = sd(leeftijd_EI, na.rm=T),
            cdn_educ_EIM_w = wtd.mean(leeftijd_EI, cdn_size, normwt = FALSE, na.rm = TRUE), #perhaps better to set normwt to TRUE
            sd_w = sqrt(wtd.var(leeftijd_EI, cdn_size, normwt = FALSE, na.rm = TRUE))) %>%
  mutate(
    conf.interval = .95,
    se = sd / sqrt(N) ,
    ci = se * qt(conf.interval/2 + .5, N-1),
    se_w = sd_w / sqrt(N) , #is this correct??
    ci_w = se_w * qt(conf.interval/2 + .5, N-1)) %>%   
  na.omit() -> tgc



datajt_nk %>% 
   filter(!is.na(leeftijd)) %>%
  group_by(survey_wave, leeftijd_cat13) %>%
  summarise(N = n(),
            cdn_leeftijd_EIM = mean(leeftijd_EI, na.rm=T),
            sd = sd(leeftijd_EI, na.rm=T),
            cdn_educ_EIM_w = wtd.mean(leeftijd_EI, cdn_size, normwt = FALSE, na.rm = TRUE), #perhaps better to set normwt to TRUE
            sd_w = sqrt(wtd.var(leeftijd_EI, cdn_size, normwt = FALSE, na.rm = TRUE))) %>%
  mutate(
    conf.interval = .95,
    se = sd / sqrt(N) ,
    ci = se * qt(conf.interval/2 + .5, N-1),
    se_w = sd_w / sqrt(N) , #is this correct??
    ci_w = se_w * qt(conf.interval/2 + .5, N-1)) %>%   
  na.omit() -> tgc_nk

``` 
```{r}

test <- cut(as.numeric(liss_long$leeftijd),breaks = c(-Inf, 15, 20, 25, 30, 35, 40,45,50,55,60,65,70, Inf))
#levels(test)

ggplot(tgc_nk, aes(x=as.numeric(survey_wave), y=cdn_leeftijd_EIM, colour=as.factor(leeftijd_cat13))) + 
    geom_errorbar(aes(ymin=cdn_leeftijd_EIM-ci, ymax=cdn_leeftijd_EIM+ci), width=.6, position=position_dodge(0.1)) +
    geom_line(position=position_dodge(0.1)) +
    geom_point(position=position_dodge(0.1)) + 
    scale_x_continuous(breaks = 1:11, limits = c(0,12), labels = as.character(c(2011:2021))) +
    scale_y_continuous(breaks = c(-.5,0,.5), limits = c(-1,.8)) + 
    labs(title = "Age homogeneity \n (EI-index, higher scores more homogeneity)", caption = "Note: 95% CI \n Source: CentERdata 2021", 
       y = "EI-index", x="period") + 
    scale_colour_hue(name="age ego",    # Legend label, use darker colors
                     #breaks=c("1", "2"),
                     labels=levels(test),
                     l=40)       +              # Use darker colors, lightness=40
    theme(legend.justification=c(1,0),
          legend.position="right")  
  
```



## Take Home Message  

- Partners influence each others opinions.
  - React to shocks  
  - Convergence  
- Influence just as strong for men/women.  

---  


## References
